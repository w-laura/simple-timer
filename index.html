<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shared Countdown Timer</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: black;
      color: white;
      font-family: 'Arial', sans-serif;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 1rem;
      box-sizing: border-box;
    }

    .display {
      font-size: 12vw;
      text-align: center;
      margin-bottom: 2rem;
    }

    .rotated {
      transform: rotate(90deg);
      transform-origin: center;
    }

    button, input {
      font-size: 1rem;
      padding: 0.5rem 1rem;
      margin: 0.5rem;
    }

    input[type="number"] {
      width: 80px;
    }

    .link {
      font-size: 0.8rem;
      margin-top: 1rem;
      word-break: break-word;
      text-align: center;
      color: lightgray;
    }

    .hidden {
      display: none;
    }

    .white-button {
      background: white;
      color: black;
      border: none;
      border-radius: 0.4rem;
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <div class="display" id="timer">--:--</div>

    <div id="controls">
      <div>
        <button onclick="togglePause()" id="pauseBtn" class="white-button">‚ñ∂Ô∏è Start</button>
        <button onclick="resetTimer()" class="white-button">üîÑ Reset</button>
      </div>
      <div>
        <input type="number" id="minutes" min="1" value="5" /> min
        <button onclick="changeDuration()" class="white-button">Set</button>
      </div>
      <div class="link" id="share-link"></div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const id = params.get("id") || "default";
    const view = params.get("view");
    const rotate = params.get("rotate");
    const storageKey = `shared-timer-${id}`;
    const isDisplay = view === "display";

    const timerEl = document.getElementById("timer");
    const pauseBtn = document.getElementById("pauseBtn");
    const minutesInput = document.getElementById("minutes");
    const shareLinkEl = document.getElementById("share-link");
    const controlsEl = document.getElementById("controls");
    const appEl = document.getElementById("app");

    let timerData = {
      duration: 5 * 60 * 1000, // ms
      endTime: null,
      paused: true
    };

    function save() {
      localStorage.setItem(storageKey, JSON.stringify(timerData));
    }

    function load() {
      const data = localStorage.getItem(storageKey);
      if (data) {
        try {
          timerData = JSON.parse(data);
        } catch (e) {}
      }
    }

    function formatTime(ms) {
      const totalSec = Math.max(0, Math.floor(ms / 1000));
      const mins = String(Math.floor(totalSec / 60)).padStart(2, '0');
      const secs = String(totalSec % 60).padStart(2, '0');
      return `${mins}:${secs}`;
    }

    function updateDisplay() {
      load();
      if (timerData.paused) {
        const remaining = timerData.endTime ? timerData.endTime - Date.now() : timerData.duration;
        timerEl.textContent = formatTime(remaining);
        if (pauseBtn) pauseBtn.textContent = "‚ñ∂Ô∏è Start";
      } else {
        const remaining = timerData.endTime - Date.now();
        if (remaining <= 0) {
          timerEl.textContent = "00:00";
          timerData.paused = true;
          timerData.endTime = null;
          save();
        } else {
          timerEl.textContent = formatTime(remaining);
        }
        if (pauseBtn) pauseBtn.textContent = "‚è∏ Pause";
      }
    }

    function togglePause() {
      load();
      if (timerData.paused) {
        timerData.endTime = Date.now() + (timerData.duration || 0);
        timerData.paused = false;
      } else {
        const remaining = timerData.endTime - Date.now();
        timerData.duration = remaining;
        timerData.endTime = null;
        timerData.paused = true;
      }
      save();
      updateDisplay();
    }

    function resetTimer() {
      const minutes = parseInt(minutesInput.value) || 5;
      timerData.duration = minutes * 60 * 1000;
      timerData.endTime = null;
      timerData.paused = true;
      save();
      updateDisplay();
    }

    function changeDuration() {
      resetTimer(); // same logic
    }

    function initUI() {
      if (isDisplay) {
        controlsEl.classList.add("hidden");
        if (rotate === "90") {
          timerEl.classList.add("rotated");
        }
      } else {
        const cleanUrl = `${location.origin}${location.pathname}?id=${id}&view=display`;
        const rotUrl = cleanUrl + "&rotate=90";
        shareLinkEl.innerHTML = `
          <strong>Shareable Display:</strong><br>
          <a href="${cleanUrl}" style="color:lightblue">${cleanUrl}</a><br>
          Upright: <a href="${rotUrl}" style="color:lightblue">${rotUrl}</a>
        `;
      }
    }

    initUI();
    setInterval(updateDisplay, 500);
    load();
    updateDisplay();
  </script>
</body>
</html>
