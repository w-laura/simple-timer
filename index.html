<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Supabase Shared Timer</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { background: black; color: white; font-family: sans-serif; text-align: center; margin: 0; height: 100vh; display: flex; flex-direction: column; justify-content: center; }
    #timer { font-size: 15vw; }
    #controls { margin-top: 20px; }
    input, button { font-size: 1.5rem; margin: 0 10px; }
  </style>
</head>
<body>
  <div id="timer">--:--</div>
  <div id="controls">
    <input id="minutes" type="number" min="1" value="5" /> min
    <button id="startBtn">‚ñ∂Ô∏è Start</button>
    <button id="resetBtn">üîÑ Reset</button>
  </div>

  <script>
    const SUPABASE_URL = 'https://keymiryybvqksaxkjdan.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtleW1pcnl5YnZxa3NheGtqZGFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwMDIyMzUsImV4cCI6MjA2NTU3ODIzNX0.qhDDnLTMGDzNYHA77c9yEHsH8zozECggGwKev4FMzNU';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const TIMER_ID = 'focus';
  
    const timerEl = document.getElementById('timer');
    let endTime = null;
    let timerInterval = null;
  
    async function fetchTimer() {
      const { data, error } = await supabase
        .from('timers')
        .select('*')
        .eq('id', TIMER_ID)
        .single();
  
      console.log("fetchTimer data:", data);
      console.log("fetchTimer error:", error);
  
      if (data && data.start_at && data.seconds) {
        const start = new Date(data.start_at).getTime();
        endTime = start + data.seconds * 1000;
        startInterval();
      } else {
        endTime = null;
        updateTimerDisplay();
      }
    }
  
    function updateTimerDisplay() {
      if (!endTime) {
        timerEl.textContent = '--:--';
        return;
      }
  
      const now = Date.now();
      const remaining = Math.max(0, endTime - now);
      const mins = String(Math.floor(remaining / 60000)).padStart(2, '0');
      const secs = String(Math.floor((remaining % 60000) / 1000)).padStart(2, '0');
  
      timerEl.textContent = `${mins}:${secs}`;
    }
  
    function startInterval() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
      updateTimerDisplay(); // call immediately
    }
  
    fetchTimer(); // load on start
  </script>
</body>
</html>
